<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cascade: Queries In Depth</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Cascade
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('queries_in_depth.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Queries In Depth</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Every successful query results in a collection, and so it is worth reading Collections in Depth before this page.</p>
<h2><a class="anchor" id="autotoc_md52"></a>
Query Method Overview</h2>
<p>The basic signature of the Query method is:</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> async Task&lt;IEnumerable&lt;M&gt;&gt; Query&lt;M&gt;(</div>
<div class="line">    <span class="keywordtype">string</span> collectionName,</div>
<div class="line">    <span class="keywordtype">object</span> criteria,</div>
<div class="line">    IEnumerable&lt;string&gt; populate = <span class="keyword">null</span>,</div>
<div class="line">    <span class="keywordtype">int</span>? freshnessSeconds = <span class="keyword">null</span>,</div>
<div class="line">    <span class="keywordtype">int</span>? populateFreshnessSeconds = <span class="keyword">null</span>,</div>
<div class="line">    <span class="keywordtype">bool</span>? hold = <span class="keyword">null</span></div>
<div class="line">) where M : class</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md53"></a>
Collection Creation and Naming</h2>
<p>The first time you call the Query method with a model type, collection name and criteria, the query is executed on the origin and then the resulting ids are stored in all cache layers using the collection name.</p>
<p>On future calls, the collection name is used to retrieve any past results that match the model type, collection name and criteria. If freshness requirements are met, the cached value is returned.</p>
<p>When you call the Query method, Cascade creates or uses an existing collection to store the results. The collection name is a combination of the provided <code>collectionName</code> parameter and a hash of the <code>criteria</code> object. This approach ensures that different query criteria result in distinct collections, even if they share the same base collection name.</p>
<p>For example:</p>
<div class="fragment"><div class="line">var criteria = <span class="keyword">new</span> { Status = <span class="stringliteral">&quot;Active&quot;</span>, Category = <span class="stringliteral">&quot;Electronics&quot;</span> };</div>
<div class="line">var results = await cascade.Query&lt;Product&gt;(<span class="stringliteral">&quot;ProductList&quot;</span>, criteria);</div>
</div><!-- fragment --><p>Internally, Cascade might generate a collection name like "ProductList_hash(criteria)", where the hash is derived from the criteria object.</p>
<h2><a class="anchor" id="autotoc_md54"></a>
Criteria Processing</h2>
<p>The <code>criteria</code> object is serialized and becomes part of the collection name. This is crucial for distinguishing between different queries and their respective result sets. The actual interpretation and application of the criteria are handled by the ICascadeOrigin implementation.</p>
<p>The ICascadeOrigin is responsible for translating the criteria into a format that the underlying data source can understand. For example, if the Origin is a RESTful API, the criteria might be converted into query parameters. If it's a SQL database, the criteria could be translated into WHERE clauses.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
Freshness and Result Caching</h2>
<p>The <code>freshnessSeconds</code> parameter plays a vital role in determining whether to execute the query or return cached results:</p>
<ol type="1">
<li>If the collection exists and is fresh (based on <code>freshnessSeconds</code>), Cascade returns the cached results without executing the query against the Origin.</li>
<li>If the collection doesn't exist or is stale, Cascade executes the query against the Origin, stores the results in the collection, and then returns them.</li>
</ol>
<p>This mechanism allows for efficient caching of query results, reducing unnecessary network calls and database load.</p>
<h2><a class="anchor" id="autotoc_md56"></a>
Query Execution Flow</h2>
<ol type="1">
<li>App or Cascade calls Query with model type, collection name and criteria</li>
<li>Cascade checks if a collection with this name exists and is fresh enough.</li>
<li>If the collection is fresh, it returns the cached results.</li>
<li>If not, it executes the query through the ICascadeOrigin implementation.</li>
<li>The Origin applies the criteria to filter the data.</li>
<li>Cascade receives the results, stores them in the cache layers with the collection name, and returns them to the caller.</li>
</ol>
<h2><a class="anchor" id="autotoc_md57"></a>
Example Scenario</h2>
<p>Let's walk through an example:</p>
<div class="fragment"><div class="line">var criteria = <span class="keyword">new</span> { Department = <span class="stringliteral">&quot;Sales&quot;</span>, MinSalary = 50000 };</div>
<div class="line">var employees = await cascade.Query&lt;Employee&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;EmployeeList&quot;</span>,</div>
<div class="line">    criteria,</div>
<div class="line">    freshnessSeconds: 300 <span class="comment">// 5 minutes</span></div>
<div class="line">);</div>
</div><!-- fragment --><ol type="1">
<li>Cascade generates a collection name, e.g., "EmployeeList_hash(criteria)".</li>
<li>It checks if this collection exists and was last updated less than 5 minutes ago.</li>
<li>If so, it returns the cached results.</li>
<li>If not, it sends the query to the Origin.</li>
<li>The Origin (e.g., a database) applies the criteria, filtering for Sales employees with salaries &gt;= 50000.</li>
<li>Cascade receives the results, caches them in the collection, and returns them.</li>
</ol>
<h2><a class="anchor" id="autotoc_md58"></a>
Criteria Flexibility</h2>
<p>The <code>criteria</code> object can be as simple or complex as needed. It could be a dictionary, an anonymous object, or a custom class. The ICascadeOrigin implementation is responsible for interpreting this object and applying it to the data source.</p>
<p>For instance, an Origin might support advanced querying features:</p>
<div class="fragment"><div class="line">var criteria = <span class="keyword">new</span> {</div>
<div class="line">    Department = <span class="stringliteral">&quot;Sales&quot;</span>,</div>
<div class="line">    Salary = <span class="keyword">new</span> { Min = 50000, Max = 100000 },</div>
<div class="line">    HireDate = <span class="keyword">new</span> { After = DateTime.Now.AddYears(-5) }</div>
<div class="line">};</div>
</div><!-- fragment --><p>The Origin would then translate this into appropriate filtering logic for its data source.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Conclusion</h2>
<p>The Query method in Cascade provides a powerful and flexible way to retrieve data, balancing efficiency through caching with the need for fresh data. By incorporating the criteria into the collection name and leveraging the ICascadeOrigin for actual data retrieval, Cascade offers a robust solution for querying data in various scenarios. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
